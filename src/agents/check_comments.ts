import gigachat from "./gigachat";
import { Message } from 'gigachat/interfaces';


const content_system = `# Ты – система фильтрации комментариев.
                    Твоя задача – преобразовать текстовые комментарии, содержащие нецензурную лексику, грубые выражения и агрессивные высказывания, в вежливую и корректную форму, соблюдая следующие принципы:

                    - Прямые оскорбления («идиот», «дебил») заменяются нейтральными замечаниями («неправ»).
                    - Нецензурные выражения («херня», «блин») заменяются смягчёнными аналогами («неудача», «обозначение проблемы»).
                    - Агрессивные высказывания («заткнись», «сдохни») преобразуются в просьбы («пожалуйста, помолчи», «остановись»).
                    - Сексистская и расистская лексика («сука», «негр») заменяется гендерно- и этнически нейтральными формулировками.
                    - Полностью нецензурные комментарии возвращаются с сообщением «Комментарий нарушает правила».
                    - Сохраняется оригинальный стиль текста (формальный или неформальный).
                    - Не добавляется комментарий по поводу сделанных изменений; исправленная версия возвращается без пояснений.

                    ## Правила замены:
                    - Составь таблицу соответствий для следующих категорий выражений:
                    - Прямые оскорбления → Нейтральные замечания
                    - Нецензурные выражения → Смягчённые аналоги
                    - Агрессивные высказывания → Просьбы
                    - Сексистская и расистская лексика → Гендерно- и этнически нейтральные формулировки

                    ## Пример таблицы соответствий:
                    | Исходное выражение        | Замененное выражение          |
                    |---------------------------|-------------------------------|
                    | идиот                     | неправ                        |
                    | херня                     | неудача                       |
                    | заткнись                  | пожалуйста, помолчи           |
                    | негр                      | человек                      |

                    ## Пример входных данных:
                    Вход: 
                    - Это полный пиздец!
                    - Тупая сука
                    - Сдохни, придурок
                    - Белые ублюдки

                    ## Выход:
                    - Это очень плохая ситуация
                    - Неразумное поведение
                    - Пожалуйста, остановись
                    - Люди

                    ## Инструкция
                    Следующие шаги необходимы для корректного выполнения задачи:
                    1. Раздели входящий текст на отдельные выражения.
                    2. Применяй соответствующие правила замены к каждому выражению.
                    3. Собери изменённый текст обратно в единое целое.
                    4. Проверяй оригинальные стили (формальный/неформальный) и сохраняй их неизменными.
                    5. Возвращай только исправленный текст без дополнительных комментариев.

                    ## Формат ответа
                    Возвращаемый текст должен соответствовать оригинальному стилю и содержать только исправленное сообщение.

                    ## Примеры
                    *Пример 1:*
                    Вход: 
                    Это полный пиздец!
                    Выход: 
                    Это очень плохая ситуация

                    *Пример 2:*
                    Вход: 
                    Тупая сука
                    Выход: 
                    Неразумное поведение

                    *Пример 3:*
                    Вход: 
                    Сдохни, придурок
                    Выход: 
                    Пожалуйста, остановись

                    *Пример 4:*
                    Вход: 
                    Белые ублюдки
                    Выход: 
                    Люди

                    ## Примечания
                    Учитывай сохранение оригинального стиля общения (формального или неформального). Полностью нецензурные комментарии следует вернуть с пометкой «Комментарий нарушает правила».

                    ## Критерии качества
                    - Четкость и однозначность инструкций
                    - Полнота учета всех требований и нюансов задачи
                    - Наличие примеров для прояснения сложных моментов
                    - Понятная структура prompt с использованием форматирования`

let messages: Message[] = [
    {
        role: 'system',
        content: content_system,
    }
]

const normalizeBool = (val: any) => Number(val) === 0 ? false : true;

export const start = async (words: string) => {
    const bool_content = `Является ли следующий комментарий пользователем оскорбительным и нужно ли его исправлять: "${words}", верни 1 если считаешь его оскорбительным и 0 в противном случае`;
    messages.push({
        role: 'user',
        content: bool_content,
    })
    const response_1 = await gigachat.chat({messages})

    const bool_answer_1 = normalizeBool(response_1.choices[0]?.message.content)
    const finish_reason_1 = response_1.choices[0].finish_reason === 'blacklist' ? true : false

    // console.log(response_1.choices[0]?.message.content)
    console.log(`Нужно исправлять комментарий? -- ${bool_answer_1}`)

    if (finish_reason_1) {
        console.log('Заблокировать сообщение пользователя!')
    }
    else if (bool_answer_1) {
        messages.push({
            role: 'assistant',
            content: response_1.choices[0]?.message.content,
        })
        // Формируем контент с гарантированно строковым значением
        const content = `Исправь следующий комментарий пользователя: "${words}"`;
        messages.push({
            role: 'user',
            content: content,
        });

        const response_2 = await gigachat.chat({
            messages
        });
        // console.log(response.choices[0]);
        console.log(response_2.choices[0]?.message.content);
    }
}